<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flux</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script type="module">
        // Import the functions you need from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase access
        window.firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Wait for DOM to be ready before initializing Firebase
        document.addEventListener('DOMContentLoaded', async () => {
            if (Object.keys(window.firebaseConfig).length > 0) {
                const app = initializeApp(window.firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                
                try {
                    if (window.initialAuthToken) {
                        await signInWithCustomToken(window.auth, window.initialAuthToken);
                    } else {
                        await signInAnonymously(window.auth);
                    }
                } catch (error) {
                    console.error("Firebase authentication error:", error);
                }

                // Listen for auth state changes to update the UI
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        console.log("User is signed in with UID:", user.uid);
                        window.userId = user.uid;
                        document.getElementById('user-id-display').textContent = `User ID: ${user.uid}`;
                        renderFluxApp(); // Re-render once authenticated
                    } else {
                        console.log("User is signed out.");
                        window.userId = null;
                        document.getElementById('user-id-display').textContent = 'Not signed in';
                    }
                });
            } else {
                console.warn("Firebase config not available. Cloud features will be disabled.");
            }
        });
    </script>
    <style>
        /* General styling for a nice, clean look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Style for the custom modal dialog */
        .custom-alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .custom-alert-box {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 90%;
            min-width: 300px;
            text-align: center;
            max-height: 80vh; /* Set a max height for the modal */
            overflow-y: auto; /* Enable vertical scrolling */
        }
        
        /* Carousel-specific styles */
        .carousel-container {
            position: relative;
            max-width: 100%;
            margin: auto;
            overflow: hidden;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .carousel-slides {
            display: flex;
            transition: transform 0.5s ease-in-out;
        }
        .carousel-slide {
            min-width: 100%;
            flex-shrink: 0;
            display: none; /* Hide all slides by default */
        }
        .carousel-slide.active {
            display: block;
        }
        .carousel-slide img {
            width: 100%;
            height: auto;
            object-fit: cover;
        }
        .carousel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            cursor: pointer;
            padding: 1rem;
            z-index: 10;
            transition: background-color 0.3s;
        }
        .carousel-btn:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }
        .carousel-prev {
            left: 0;
            border-top-right-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }
        .carousel-next {
            right: 0;
            border-top-left-radius: 0.5rem;
            border-bottom-left-radius: 0.5rem;
        }

        /* Iframe-specific styles */
        #iframe-view-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        #iframe-container {
            flex-grow: 1;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        /* Chart container styles */
        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
            margin-top: 1rem;
        }

        /* Circular progress styling */
        .circular-progress {
            position: relative;
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .circular-progress svg {
            position: absolute;
            top: 0;
            left: 0;
            transform: rotate(-90deg);
        }
        .circular-progress svg circle {
            transition: stroke-dashoffset 0.5s ease-in-out;
        }
        
        /* Modal styling */
        .flux-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .flux-modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 500px;
            min-width: 300px;
            text-align: center;
        }

        /* Styling for the new single-textarea editor */
        #flux-editor {
            width: 100%;
            height: 100%;
            font-size: 0.875rem;
            line-height: 1.5;
            margin: 0;
            padding: 1rem;
            border: none;
            background-color: white; /* Changed to white */
            color: #1f2937; /* Changed to dark gray for readability */
            white-space: pre;
            word-wrap: normal;
            resize: none;
            outline: none;
            font-family: 'Fira Code', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace;
        }
        #flux-editor::placeholder {
            color: #6b7280; /* Darker placeholder text for visibility on white background */
        }
    </style>
</head>
<body class="bg-gray-100 p-4">

    <div class="min-h-screen flex flex-col lg:flex-row items-start justify-center p-4 gap-4">

        <div id="main-app-container" class="w-full lg:w-1/2 p-4 bg-white rounded-xl shadow-2xl flex flex-col h-[70vh] lg:h-[80vh]">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-indigo-600">Flux Editor</h2>
                <button id="commands-list-btn" class="p-2 rounded-full bg-indigo-100 text-indigo-600 hover:bg-indigo-200 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
            </div>
            <textarea
                id="flux-editor"
                spellcheck="false"
                class="font-mono text-sm flex-grow border border-gray-300 rounded-lg"
                placeholder="Enter your Flux code here..."
            ></textarea>
            
            <div id="error-message" class="mt-4 p-3 bg-red-100 text-red-700 border border-red-400 rounded-lg font-mono text-sm hidden">
                <p id="error-message-text"></p>
            </div>
        </div>

        <div id="rendered-app-container" class="w-full lg:w-1/2 p-4 bg-white rounded-xl shadow-2xl flex flex-col h-auto lg:h-[80vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-4 text-indigo-600">Rendered Flux Application</h2>
            
            <p id="user-id-display" class="text-sm text-gray-500 mb-4 font-mono"></p>

            <div id="rendered-output" class="flex-grow p-4 bg-gray-50 rounded-lg">
                <div id="dynamic-output" class="hidden">
                    </div>
            </div>

            <div id="iframe-view-container" class="hidden">
                <div id="iframe-container" class="flex-grow"></div>
            </div>
        </div>

    </div>

    <div id="custom-alert-modal" class="custom-alert-overlay hidden">
      <div class="custom-alert-box">
        <p id="custom-alert-text" class="text-gray-800"></p>
        <div class="mt-4 flex justify-center space-x-4">
            <button id="custom-alert-close" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">OK</button>
        </div>
      </div>
    </div>


    <script type="module">
        // Import all the command logic from our separate file
        import { initializeFluxCommands, executeFluxCommands, showCustomAlert, showMainAppView } from './flux_commands.ts';

        // === State Variables ===
        let fluxCode = '';
        let fluxCommands = [];
        let error = null;

        // === DOM Element References ===
        const editor = document.getElementById('flux-editor');
        const outputContainer = document.getElementById('rendered-output');
        const dynamicOutputContainer = document.getElementById('dynamic-output');
        const errorContainer = document.getElementById('error-message');
        const errorText = document.getElementById('error-message-text');
        const commandsListBtn = document.getElementById('commands-list-btn');
        
        // Initialize the command handlers
        initializeFluxCommands();

        // --- Commands List Function (now a simple message) ---
        const showCommandsList = () => {
            const commandsList = `
                <h3 class="font-bold text-xl mb-4">Available Commands</h3>
                <ul class="text-left">
                    <li class="mb-2"><strong>heading:</strong> <code>text="string", size="h1|h2|h3|h4", color="tailwind-color-class", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>paragraph:</strong> <code>text="string", color="tailwind-color-class", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>list:</strong> <code>title="string", items=["item1", "item2"], listStyle="numbered|bulleted", itemStyle="tailwind-style-classes", color="tailwind-color-class", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>button:</strong> <code>text="string", style="tailwind-style-classes", onClick="flux commands"</code></li>
                    <li class="mb-2"><strong>divider:</strong> <code>color="tailwind-color-class", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>card:</strong> <code>title="string", text="string", style="tailwind-style-classes", id="string(optional)"</code></li>
                    <li class="mb-2"><strong>show:</strong> <code>id="string"</code></li>
                    <li class="mb-2"><strong>hide:</strong> <code>id="string"</code></li>
                    <li class="mb-2"><strong>wait:</strong> <code>seconds="number"</code></li>
                    <li class="mb-2"><strong>input:</strong> <code>id="string", placeholder="string", style="tailwind-style-classes"</code></li>
                    <li class="mb-2"><strong>textarea:</strong> <code>id="string", placeholder="string", style="tailwind-style-classes"</code></li>
                    <li class="mb-2"><strong>alert:</strong> <code>text="string", type="success|warning|error|info"</code></li>
                    <li class="mb-2"><strong>progress:</strong> <code>label="string", value="number", max="number", id="string"</code></li>
                    <li class="mb-2"><strong>link:</strong> <code>text="string", url="string"</code> (loads URL in iframe)</li>
                    <li class="mb-2"><strong>iframe:</strong> <code>url="string"</code> (loads URL in iframe)</li>
                    <li class="mb-2"><strong>search:</strong> <code>query="string", queries="number"</code></li>
                    <li class="mb-2"><strong>show.image:</strong> <code>text="string", id="string"</code></li>
                    <li class="mb-2"><strong>table:</strong> <code>headers=["Header1", "Header2"], rows=[["data1", "data2"]], id="string(optional)"</code></li>
                    <li class="mb-2"><strong>carousel:</strong> <code>images=["url1", "url2"], id="string(optional)"</code></li>
                    <li class="mb-2"><strong>chart:</strong> <code>type="bar|line|pie", labels=["label1", "label2"], data=[10, 20], title="string" (optional), id="string(optional)"</code></li>
                    <li class="mb-2"><strong>form:</strong> <code>id="string"</code> (a container for inputs)</li>
                    <li class="mb-2"><strong>submit:</strong> <code>formId="string", text="string", onClick="flux commands"</code></li>
                    <li class="mb-2"><strong>store:</strong> <code>id="string", value="string"</code></li>
                    <li class="mb-2"><strong>load:</strong> <code>id="string"</code></li>
                    <li class="mb-2 font-bold">--- New UI Commands ---</li>
                    <li class="mb-2"><strong>badge:</strong> <code>text="string", color="tailwind-color-class"</code></li>
                    <li class="mb-2"><strong>circular-progress:</strong> <code>value="number", max="number", size="number(px)", color="tailwind-color-class"</code></li>
                    <li class="mb-2"><strong>toggle:</strong> <code>id="string", label="string"</code></li>
                    <li class="mb-2"><strong>radio-group:</strong> <code>name="string", options=["option1", "option2"]</code></li>
                    <li class="mb-2"><strong>checkbox-group:</strong> <code>name="string", options=["option1", "option2"]</code></li>
                    <li class="mb-2"><strong>dropdown:</strong> <code>id="string", options=["option1", "option2"], label="string"</code></li>
                    <li class="mb-2"><strong>modal:</strong> <code>id="string", title="string", text="string"</code></li>
                    <li class="mb-2"><strong>button.modal:</strong> <code>text="string", modalId="string", style="tailwind-style-classes"</code></li>
                    <li class="mb-2"><strong>loop:</strong> <code>count="number"</code> followed by commands and <strong>endloop</strong></li>
                </ul>
            `;
            showCustomAlert(commandsList);
        };
        
        // --- The Custom Language Parser ---
        const parseFluxCode = (codeString) => {
            const lines = codeString.split('\n');
            const parsedCommands = [];
            let parsingError = null;
            let i = 0;
            
            const parseBlock = () => {
                const blockCommands = [];
                while (i < lines.length) {
                    const line = lines[i].trim();
                    i++;
                    
                    if (line.startsWith('#') || line === '') {
                        continue;
                    }
                    if (line === 'endloop') {
                        return blockCommands;
                    }

                    const colonIndex = line.indexOf(':');
                    if (colonIndex === -1) {
                        parsingError = `Syntax Error: Malformed command on line "${line}". Expected "type: key=value".`;
                        return null;
                    }
        
                    const type = line.substring(0, colonIndex).trim();
                    const propsPart = line.substring(colonIndex + 1).trim();
        
                    if (!type || !propsPart) {
                        parsingError = `Syntax Error: Malformed command on line "${line}". Expected "type: key=value".`;
                        return null;
                    }
        
                    const props = {};
                    const parts = propsPart.split(/,(?![^[]*\])/);
                    for (const part of parts) {
                        const [key, value] = part.split('=').map(s => s.trim());
                        if (!key || !value) { continue; }
            
                        let cleanValue;
                        if (value.startsWith('"') && value.endsWith('"')) {
                            cleanValue = value.slice(1, -1);
                        } else if (value.startsWith('[') && value.endsWith(']')) {
                            try {
                                cleanValue = JSON.parse(value);
                            } catch (e) {
                                parsingError = `Syntax Error: Invalid JSON array format for "${key}" on line "${line}".`;
                                return null;
                            }
                        } else {
                            cleanValue = value;
                        }
                        props[key] = cleanValue;
                    }
                    
                    if (type === 'loop') {
                        const loopBlock = parseBlock();
                        if (parsingError) return null;
                        blockCommands.push({ type, props, commands: loopBlock });
                    } else {
                        blockCommands.push({ type, props });
                    }
                }
                return blockCommands;
            };

            const commands = parseBlock();

            if (parsingError) {
                error = parsingError;
                fluxCommands = [];
            } else {
                error = null;
                fluxCommands = commands;
            }
            return { commands: fluxCommands, error: parsingError };
        };

        // --- Main Rendering and Event Handling ---
        const renderFluxApp = async () => {
            // Clear previous output and errors
            if (dynamicOutputContainer) {
                dynamicOutputContainer.innerHTML = '';
                dynamicOutputContainer.classList.add('hidden');
            }
            errorContainer.classList.add('hidden');
            showMainAppView();

            if (!fluxCode) {
                return;
            }

            const { commands, error: parseError } = parseFluxCode(editor.value);
            if (parseError) {
                errorText.textContent = parseError;
                errorContainer.classList.remove('hidden');
                return;
            }

            if (commands && dynamicOutputContainer) {
                dynamicOutputContainer.classList.remove('hidden');
                await executeFluxCommands(commands, dynamicOutputContainer);
            }
        };

        // Event listener for editor input
        editor.addEventListener('input', () => {
            fluxCode = editor.value;
            renderFluxApp();
        });

        // Event listener for the commands list button
        commandsListBtn.addEventListener('click', showCommandsList);

        // Initial render
        renderFluxApp();
    </script>
</body>
</html>
